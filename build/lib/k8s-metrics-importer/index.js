"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.K8sMetricsImporter = void 0;
const https = require('https');
const axios = require('axios');
const K8sMetricsImporter = (globalConfig) => {
    const metadata = {
        kind: 'execute',
    };
    /**
     * Execute's strategy description here.
     * validate vars
     * get cluster metrics
     * get cluster node details
     * match pods & nodes calculate percentage usage
     * output result
     */
    const execute = async (inputs, config) => {
        const mergedConfig = Object.assign({}, globalConfig, config);
        let token = '';
        if (mergedConfig['token']) {
            token = mergedConfig['token'];
        }
        else if (process.env.K8S_TOKEN) {
            token = process.env.K8S_TOKEN;
        }
        else {
            console.log('No token set. we wont generate or add anything...');
        }
        if (token === '') {
            return inputs;
        }
        let k8sHostURL = '';
        if (mergedConfig['k8s-host-url']) {
            k8sHostURL = mergedConfig['k8s-host-url'];
        }
        else if (process.env.K8S_HOST_URL) {
            k8sHostURL = process.env.K8S_HOST_URL;
        }
        else {
            k8sHostURL = 'https://localhost:6443';
        }
        function getNodeTotalCPU(nodes, nodeName) {
            let output = 1;
            nodes.forEach(node => {
                if (node['metadata']['name'] === nodeName) {
                    output = parseInt(node['status']['capacity']['cpu']);
                }
            });
            return output;
        }
        function getNodeTotalMemory(nodes, nodeName) {
            let output = 1000000;
            nodes.forEach(node => {
                if (node['metadata']['name'] === nodeName) {
                    output = parseInt(node['status']['capacity']['memory'].match(/(\d+)/)[0]);
                }
            });
            return output;
        }
        function getPodNodeName(pods, podName) {
            let output = 'default';
            pods.forEach(pod => {
                if (pod['metadata']['name'] === podName) {
                    // console.log('gotenm', pod['metadata']['name']);
                    output = pod['spec']['nodeName'];
                }
            });
            return output;
        }
        const containers = [];
        const client = axios.create({
            timeout: 60000,
            httpsAgent: new https.Agent({ keepAlive: true }),
        });
        // console.log('getting nodes');
        const nodeRes = await client.get(k8sHostURL + '/api/v1/nodes', {
            headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json',
                Authorization: `Bearer ${token}`,
            },
        });
        // get metadata
        // console.log(res.status);
        if (nodeRes.status === 200) {
            console.log('Got node meta');
            // console.log('insiode', JSON.stringify(nodeRes.data));
            // return res.data;
        }
        else {
            throw new Error('Could not retrieve metrics' + nodeRes.data);
        }
        // console.log('getting pods');
        const podRes = await client.get(k8sHostURL + '/api/v1/pods', {
            headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json',
                Authorization: `Bearer ${token}`,
            },
        });
        // get metadata
        // console.log(res.status);
        if (podRes.status === 200) {
            console.log('Got pod meta');
            // console.log('pods - ', JSON.stringify(podRes.data));
            // return res.data;
        }
        else {
            throw new Error('Could not retrieve metrics' + podRes.data);
        }
        const metricsRes = await client.get(k8sHostURL + '/apis/metrics.k8s.io/v1beta1/pods', {
            headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json',
                Authorization: `Bearer ${token}`,
            },
        });
        // get metadata
        // console.log(res.status);
        if (metricsRes.status === 200) {
            console.log('Got k8s stats');
            //   console.log("insiode", JSON.stringify(res.data));
        }
        else {
            throw new Error('Could not retrieve metrics' + metricsRes.data);
        }
        // - `memory/utilization`: percentage of the total available memory being used in the input period
        // - `memory/capacity`: the total amount of memory available, in GB
        // - `network/data-in`: inbound data in GB
        // - `network/data-out`: outbound data in GB
        metricsRes.data.items.forEach((pod) => {
            // console.log(pod.metadata.name);
            // console.log(podRes.data.items[0]);
            const nodeName = getPodNodeName(podRes.data.items, pod.metadata.name);
            pod.containers.forEach((container) => {
                containers.push(Object.assign({
                    'k8s/node/name': nodeName,
                    'k8s/pod/name': pod.metadata.name,
                    'k8s/container/name': container.name,
                    'k8s/namespace': pod.metadata.namespace,
                    'k8s/label/k8s-app': pod.metadata.labels['k8s-app'],
                    timestamp: pod.timestamp,
                    duration: parseFloat(pod.window.match(/(\d+)/)[0]),
                    'k8s/cpu/utilization': container.usage.cpu.match(/(\d+)/)[0],
                    'cpu/utilization': container.usage.cpu.match(/(\d+)/)[0] /
                        (getNodeTotalCPU(nodeRes.data.items, nodeName) *
                            1000000000),
                    'k8s/memory/utilization': container.usage.memory.match(/(\d+)/)[0],
                    'memory/utilization': container.usage.memory.match(/(\d+)/)[0] /
                        getNodeTotalMemory(nodeRes.data.items, nodeName),
                    'memory/capacity': getNodeTotalMemory(nodeRes.data.items, nodeName),
                }, ...inputs));
            });
        });
        return containers;
    };
    return {
        metadata,
        execute,
    };
};
exports.K8sMetricsImporter = K8sMetricsImporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2s4cy1tZXRyaWNzLWltcG9ydGVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUMvQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFeEIsTUFBTSxrQkFBa0IsR0FBRyxDQUNoQyxZQUEwQixFQUNULEVBQUU7SUFDbkIsTUFBTSxRQUFRLEdBQUc7UUFDZixJQUFJLEVBQUUsU0FBUztLQUNoQixDQUFDO0lBRUY7Ozs7Ozs7T0FPRztJQUNILE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDbkIsTUFBc0IsRUFDdEIsTUFBcUIsRUFDSSxFQUFFO1FBQzNCLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUU3RCxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDZixJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQzFCLEtBQUssR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDaEMsQ0FBQzthQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNqQyxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7UUFDaEMsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUVELElBQUksS0FBSyxLQUFLLEVBQUUsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUM7UUFFRCxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxZQUFZLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztZ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Q0FBQyxDQUFDLENBQUM7b0JBQzFDLG9CQUFvQixFQUNsQixTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN4QyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUM7b0JBQ2xELGlCQUFpQixFQUFFLGtCQUFrQixDQUNuQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFDbEIsUUFBUSxDQUNUO2lCQUNGLEVBQ0QsR0FBRyxNQUFNLENBQ1YsQ0FDRixDQUFDO1lBQ0osQ0FBQyxDQUNGLENBQUM7UUFDSixDQUFDLENBQ0YsQ0FBQztRQUVGLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUMsQ0FBQztJQUVGLE9BQU87UUFDTCxRQUFRO1FBQ1IsT0FBTztLQUNSLENBQUM7QUFDSixDQUFDLENBQUM7QUF2TVcsUUFBQSxrQkFBa0Isc0JBdU03QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29uZmlnUGFyYW1zfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7UGx1Z2luSW50ZXJmYWNlLCBQbHVnaW5QYXJhbXN9IGZyb20gJy4uL3R5cGVzL2ludGVyZmFjZSc7XG5cbmNvbnN0IGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKTtcbmNvbnN0IGF4aW9zID0gcmVxdWlyZSgnYXhpb3MnKTtcblxuZXhwb3J0IGNvbnN0IEs4c01ldHJpY3NJbXBvcnRlciA9IChcbiAgZ2xvYmFsQ29uZmlnOiBDb25maWdQYXJhbXNcbik6IFBsdWdpbkludGVyZmFjZSA9PiB7XG4gIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgIGtpbmQ6ICdleGVjdXRlJyxcbiAgfTtcblxuICAvKipcbiAgICogRXhlY3V0ZSdzIHN0cmF0ZWd5IGRlc2NyaXB0aW9uIGhlcmUuXG4gICAqIHZhbGlkYXRlIHZhcnNcbiAgICogZ2V0IGNsdXN0ZXIgbWV0cmljc1xuICAgKiBnZXQgY2x1c3RlciBub2RlIGRldGFpbHNcbiAgICogbWF0Y2ggcG9kcyAmIG5vZGVzIGNhbGN1bGF0ZSBwZXJjZW50YWdlIHVzYWdlXG4gICAqIG91dHB1dCByZXN1bHRcbiAgICovXG4gIGNvbnN0IGV4ZWN1dGUgPSBhc3luYyAoXG4gICAgaW5wdXRzOiBQbHVnaW5QYXJhbXNbXSxcbiAgICBjb25maWc/OiBDb25maWdQYXJhbXNcbiAgKTogUHJvbWlzZTxQbHVnaW5QYXJhbXNbXT4gPT4ge1xuICAgIGNvbnN0IG1lcmdlZENvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIGdsb2JhbENvbmZpZywgY29uZmlnKTtcblxuICAgIGxldCB0b2tlbiA9ICcnO1xuICAgIGlmIChtZXJnZWRDb25maWdbJ3Rva2VuJ10pIHtcbiAgICAgIHRva2VuID0gbWVyZ2VkQ29uZmlnWyd0b2tlbiddO1xuICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuSzhTX1RPS0VOKSB7XG4gICAgICB0b2tlbiA9IHByb2Nlc3MuZW52Lks4U19UT0tFTjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coJ05vIHRva2VuIHNldC4gd2Ugd29udCBnZW5lcmF0ZSBvciBhZGQgYW55dGhpbmcuLi4nKTtcbiAgICB9XG5cbiAgICBpZiAodG9rZW4gPT09ICcnKSB7XG4gICAgICByZXR1cm4gaW5wdXRzO1xuICAgIH1cblxuICAgIGxldCBrOHNIb3N0VVJMID0gJyc7XG4gICAgaWYgKG1lcmdlZENvbmZpZ1snazhzLWhvc3QtdXJsJ10pIHtcbiAgICAgIGs4c0hvc3RVUkwgPSBtZXJnZWRDb25maWdbJ2s4cy1ob3N0LXVybCddO1xuICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuSzhTX0hPU1RfVVJMKSB7XG4gICAgICBrOHNIb3N0VVJMID0gcHJvY2Vzcy5lbnYuSzhTX0hPU1RfVVJMO1xuICAgIH0gZWxzZSB7XG4gICAgICBrOHNIb3N0VVJMID0gJ2h0dHBzOi8vbG9jYWxob3N0OjY0NDMnO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldE5vZGVUb3RhbENQVShub2RlczogYW55W10sIG5vZGVOYW1lOiBhbnkpIHtcbiAgICAgIGxldCBvdXRwdXQgPSAxO1xuICAgICAgbm9kZXMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgaWYgKG5vZGVbJ21ldGFkYXRhJ11bJ25hbWUnXSA9PT0gbm9kZU5hbWUpIHtcbiAgICAgICAgICBvdXRwdXQgPSBwYXJzZUludChub2RlWydzdGF0dXMnXVsnY2FwYWNpdHknXVsnY3B1J10pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0Tm9kZVRvdGFsTWVtb3J5KG5vZGVzOiBhbnlbXSwgbm9kZU5hbWU6IGFueSkge1xuICAgICAgbGV0IG91dHB1dCA9IDEwMDAwMDA7XG4gICAgICBub2Rlcy5mb3JFYWNoKG5vZGUgPT4ge1xuICAgICAgICBpZiAobm9kZVsnbWV0YWRhdGEnXVsnbmFtZSddID09PSBub2RlTmFtZSkge1xuICAgICAgICAgIG91dHB1dCA9IHBhcnNlSW50KFxuICAgICAgICAgICAgbm9kZVsnc3RhdHVzJ11bJ2NhcGFjaXR5J11bJ21lbW9yeSddLm1hdGNoKC8oXFxkKykvKVswXVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIG91dHB1dDtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRQb2ROb2RlTmFtZShwb2RzOiBhbnlbXSwgcG9kTmFtZTogYW55KSB7XG4gICAgICBsZXQgb3V0cHV0ID0gJ2RlZmF1bHQnO1xuICAgICAgcG9kcy5mb3JFYWNoKHBvZCA9PiB7XG4gICAgICAgIGlmIChwb2RbJ21ldGFkYXRhJ11bJ25hbWUnXSA9PT0gcG9kTmFtZSkge1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdnb3Rlbm0nLCBwb2RbJ21ldGFkYXRhJ11bJ25hbWUnXSk7XG4gICAgICAgICAgb3V0cHV0ID0gcG9kWydzcGVjJ11bJ25vZGVOYW1lJ107XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIG91dHB1dDtcbiAgICB9XG5cbiAgICBjb25zdCBjb250YWluZXJzOiBQbHVnaW5QYXJhbXNbXSA9IFtdO1xuXG4gICAgY29uc3QgY2xpZW50ID0gYXhpb3MuY3JlYXRlKHtcbiAgICAgIHRpbWVvdXQ6IDYwMDAwLFxuICAgICAgaHR0cHNBZ2VudDogbmV3IGh0dHBzLkFnZW50KHtrZWVwQWxpdmU6IHRydWV9KSxcbiAgICB9KTtcblxuICAgIC8vIGNvbnNvbGUubG9nKCdnZXR0aW5nIG5vZGVzJyk7XG4gICAgY29uc3Qgbm9kZVJlcyA9IGF3YWl0IGNsaWVudC5nZXQoazhzSG9zdFVSTCArICcvYXBpL3YxL25vZGVzJywge1xuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZ2V0IG1ldGFkYXRhXG4gICAgLy8gY29uc29sZS5sb2cocmVzLnN0YXR1cyk7XG4gICAgaWYgKG5vZGVSZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGNvbnNvbGUubG9nKCdHb3Qgbm9kZSBtZXRhJyk7XG4gICAgICAvLyBjb25zb2xlLmxvZygnaW5zaW9kZScsIEpTT04uc3RyaW5naWZ5KG5vZGVSZXMuZGF0YSkpO1xuICAgICAgLy8gcmV0dXJuIHJlcy5kYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCByZXRyaWV2ZSBtZXRyaWNzJyArIG5vZGVSZXMuZGF0YSk7XG4gICAgfVxuXG4gICAgLy8gY29uc29sZS5sb2coJ2dldHRpbmcgcG9kcycpO1xuICAgIGNvbnN0IHBvZFJlcyA9IGF3YWl0IGNsaWVudC5nZXQoazhzSG9zdFVSTCArICcvYXBpL3YxL3BvZHMnLCB7XG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBnZXQgbWV0YWRhdGFcbiAgICAvLyBjb25zb2xlLmxvZyhyZXMuc3RhdHVzKTtcbiAgICBpZiAocG9kUmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICBjb25zb2xlLmxvZygnR290IHBvZCBtZXRhJyk7XG4gICAgICAvLyBjb25zb2xlLmxvZygncG9kcyAtICcsIEpTT04uc3RyaW5naWZ5KHBvZFJlcy5kYXRhKSk7XG4gICAgICAvLyByZXR1cm4gcmVzLmRhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IHJldHJpZXZlIG1ldHJpY3MnICsgcG9kUmVzLmRhdGEpO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldHJpY3NSZXMgPSBhd2FpdCBjbGllbnQuZ2V0KFxuICAgICAgazhzSG9zdFVSTCArICcvYXBpcy9tZXRyaWNzLms4cy5pby92MWJldGExL3BvZHMnLFxuICAgICAge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gZ2V0IG1ldGFkYXRhXG4gICAgLy8gY29uc29sZS5sb2cocmVzLnN0YXR1cyk7XG4gICAgaWYgKG1ldHJpY3NSZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIGNvbnNvbGUubG9nKCdHb3QgazhzIHN0YXRzJyk7XG4gICAgICAvLyAgIGNvbnNvbGUubG9nKFwiaW5zaW9kZVwiLCBKU09OLnN0cmluZ2lmeShyZXMuZGF0YSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCByZXRyaWV2ZSBtZXRyaWNzJyArIG1ldHJpY3NSZXMuZGF0YSk7XG4gICAgfVxuXG4gICAgLy8gLSBgbWVtb3J5L3V0aWxpemF0aW9uYDogcGVyY2VudGFnZSBvZiB0aGUgdG90YWwgYXZhaWxhYmxlIG1lbW9yeSBiZWluZyB1c2VkIGluIHRoZSBpbnB1dCBwZXJpb2RcbiAgICAvLyAtIGBtZW1vcnkvY2FwYWNpdHlgOiB0aGUgdG90YWwgYW1vdW50IG9mIG1lbW9yeSBhdmFpbGFibGUsIGluIEdCXG5cbiAgICAvLyAtIGBuZXR3b3JrL2RhdGEtaW5gOiBpbmJvdW5kIGRhdGEgaW4gR0JcbiAgICAvLyAtIGBuZXR3b3JrL2RhdGEtb3V0YDogb3V0Ym91bmQgZGF0YSBpbiBHQlxuXG4gICAgbWV0cmljc1Jlcy5kYXRhLml0ZW1zLmZvckVhY2goXG4gICAgICAocG9kOiB7XG4gICAgICAgIGNvbnRhaW5lcnM6IHtuYW1lOiBhbnk7IHVzYWdlOiB7Y3B1OiBhbnk7IG1lbW9yeTogYW55fX1bXTtcbiAgICAgICAgbWV0YWRhdGE6IHtuYW1lOiBhbnk7IG5hbWVzcGFjZTogYW55OyBsYWJlbHM6IHtbeDogc3RyaW5nXTogYW55fX07XG4gICAgICAgIHRpbWVzdGFtcDogYW55O1xuICAgICAgICB3aW5kb3c6IGFueTtcbiAgICAgIH0pID0+IHtcbiAgICAgICAgLy8gY29uc29sZS5sb2cocG9kLm1ldGFkYXRhLm5hbWUpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhwb2RSZXMuZGF0YS5pdGVtc1swXSk7XG4gICAgICAgIGNvbnN0IG5vZGVOYW1lID0gZ2V0UG9kTm9kZU5hbWUocG9kUmVzLmRhdGEuaXRlbXMsIHBvZC5tZXRhZGF0YS5uYW1lKTtcbiAgICAgICAgcG9kLmNvbnRhaW5lcnMuZm9yRWFjaChcbiAgICAgICAgICAoY29udGFpbmVyOiB7bmFtZTogYW55OyB1c2FnZToge2NwdTogYW55OyBtZW1vcnk6IGFueX19KSA9PiB7XG4gICAgICAgICAgICBjb250YWluZXJzLnB1c2goXG4gICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgJ2s4cy9ub2RlL25hbWUnOiBub2RlTmFtZSxcbiAgICAgICAgICAgICAgICAgICdrOHMvcG9kL25hbWUnOiBwb2QubWV0YWRhdGEubmFtZSxcbiAgICAgICAgICAgICAgICAgICdrOHMvY29udGFpbmVyL25hbWUnOiBjb250YWluZXIubmFtZSxcbiAgICAgICAgICAgICAgICAgICdrOHMvbmFtZXNwYWNlJzogcG9kLm1ldGFkYXRhLm5hbWVzcGFjZSxcbiAgICAgICAgICAgICAgICAgICdrOHMvbGFiZWwvazhzLWFwcCc6IHBvZC5tZXRhZGF0YS5sYWJlbHNbJ2s4cy1hcHAnXSxcbiAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogcG9kLnRpbWVzdGFtcCxcbiAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBwYXJzZUZsb2F0KHBvZC53aW5kb3cubWF0Y2goLyhcXGQrKS8pWzBdKSxcbiAgICAgICAgICAgICAgICAgICdrOHMvY3B1L3V0aWxpemF0aW9uJzogY29udGFpbmVyLnVzYWdlLmNwdS5tYXRjaCgvKFxcZCspLylbMF0sXG4gICAgICAgICAgICAgICAgICAnY3B1L3V0aWxpemF0aW9uJzpcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnVzYWdlLmNwdS5tYXRjaCgvKFxcZCspLylbMF0gL1xuICAgICAgICAgICAgICAgICAgICAoZ2V0Tm9kZVRvdGFsQ1BVKG5vZGVSZXMuZGF0YS5pdGVtcywgbm9kZU5hbWUpICpcbiAgICAgICAgICAgICAgICAgICAgICAxMDAwMDAwMDAwKSxcbiAgICAgICAgICAgICAgICAgICdrOHMvbWVtb3J5L3V0aWxpemF0aW9uJzpcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnVzYWdlLm1lbW9yeS5tYXRjaCgvKFxcZCspLylbMF0sXG4gICAgICAgICAgICAgICAgICAnbWVtb3J5L3V0aWxpemF0aW9uJzpcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnVzYWdlLm1lbW9yeS5tYXRjaCgvKFxcZCspLylbMF0gL1xuICAgICAgICAgICAgICAgICAgICBnZXROb2RlVG90YWxNZW1vcnkobm9kZVJlcy5kYXRhLml0ZW1zLCBub2RlTmFtZSksXG4gICAgICAgICAgICAgICAgICAnbWVtb3J5L2NhcGFjaXR5JzogZ2V0Tm9kZVRvdGFsTWVtb3J5KFxuICAgICAgICAgICAgICAgICAgICBub2RlUmVzLmRhdGEuaXRlbXMsXG4gICAgICAgICAgICAgICAgICAgIG5vZGVOYW1lXG4gICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLi4uaW5wdXRzXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgICk7XG5cbiAgICByZXR1cm4gY29udGFpbmVycztcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIG1ldGFkYXRhLFxuICAgIGV4ZWN1dGUsXG4gIH07XG59O1xuIl19